<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klubzmer Website — Admin Area (VIP only)</title>
    <!-- Add lodash CDN script -->
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/theme-light.css">
    <link rel="stylesheet" href="css/typography.css">
    <link rel="stylesheet" href="css/extras.css">
    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/section-about.css">
    <link rel="stylesheet" href="css/section-landing.css">
    <link rel="stylesheet" href="css/timetable.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
        <!-- Navbar -->
        <div id="admin-menu">
            <ul>
                <li><a href="#edit-about">Text: About</a></li>
                <li><a href="#edit-gigs">Edit: Gigs</a></li>
            </ul>
        </div>
        <!-- Edit About Text -->
    <main id="admin">



        <div class="admin-heading">
            <h5>Klubzmer Website</h5>
            <h1>Admin Area</h1> 
            <h5>VIP only</h5>
        </div>

        <div class="edit-outer">
            <div class="edit-inner">
                <div class="edit-heading">
                    <h2>Edit About Text</h2>
                </div>
                <textarea id="adminAboutText"></textarea>
                <div class="button-block">
                    <button class="save-button" onclick="saveText()">Save</button>
                    <p id="status"></p>
                </div>
            </div>
            <div class="edit-inner">
                <div class="edit-heading">
                    <h3>Preview</h3>
                    <p class="text-small"> — Reload to see changes</h5>
                </div>
                <p class="preview text-small" id="preview-about">This display is updated automatically.</p>
            </div>
        </div>
        <!-- Edit Gigs -->
        <div class="edit-outer">
            <div class="edit-inner">
                <h2 id="edit-gigs">Edit Gigs</h2>
                <a href="https://docs.google.com/spreadsheets/d/1DUgBEpNiNear4spHeeysMkhfGlInb-StFHKaeO2laos/edit?usp=sharing" target="_blank" rel="noopener noreferrer">
                    <button type="button">Manage Tour Dates</button>
                </a>
            </div>
            <div class="edit-inner">
                <h3>How to</h3>
               <p class="text-small">Die Tourdaten werden übersichtlich in einer Google Tabelle bearbeitet. Der Knopf öffnet eine separate Webseite. Momentan bracht es keinen Account, um die Daten zu bearbeiten, nur den Link. Aber das lässt sich schnell ändern.</p>
               <p class="text-small">Momentan wird jeder Eintrag in der Tabelle ausgelesen. Möglich wäre es nur einen Teil der Tabelle in die Website zu übertragen.</p>
            </div>
        </div>
    </main>
    <script>
        async function saveText() {
            const plainText = document.getElementById('adminAboutText').value;
            const formattedText = _.chain(plainText)
                .split(/\n{2,}/)
                .map(paragraph => `<p>${_.replace(paragraph, /\n/g, '<br>')}</p>`)
                .join('')
                .value();
    
            try {
                const response = await fetch('/api/update-text', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: formattedText })
                });
                const result = await response.json();
                document.getElementById('status').textContent = result.message || "⚠ Error saving text.";
            } catch (error) {
                console.error("Failed to save text:", error);
                document.getElementById('status').textContent = "⚠ Could not save text.";
            }
        }
    </script>
<!-- New Script -->
<script type="module">
    // ♥ Full script for admin about loader
    import { loadText } from "./textLoader.js";
  
    /**
     * @returns {Promise<void>}
     */
    async function loadAdminAbout() {
      // Load formatted text into preview
      await loadText("/api/about-text", "preview-about");
  
      // Then also fetch again for textarea parsing
      const response = await fetch("/api/about-text");
      const data = await response.json();
      // Convert HTML back to plain text
      const plainText = data.text
        .replace(/<\/p><p>/g, "\n\n")
        .replace(/<br>/g, "\n")
        .replace(/^<p>|<\/p>$/g, "");
      document.getElementById("adminAboutText").value = plainText;
    }
  
    loadAdminAbout();
  </script>
<!-- End -->
</body>
</html>