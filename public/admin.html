<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit About Text</title>
    <!-- Add lodash CDN script -->
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/theme-light.css">
    <link rel="stylesheet" href="css/typography.css">
    <link rel="stylesheet" href="css/extras.css">
    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/section-about.css">
    <link rel="stylesheet" href="css/section-landing.css">
    <link rel="stylesheet" href="css/timetable.css">
    <link rel="stylesheet" href="css/admin.css">
    <!-- <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        textarea { width: 100%; height: 150px; margin-bottom: 10px; }
        button { padding: 10px 15px; background: teal; color: white; border: none; cursor: pointer; }
        button:hover { background: darkcyan; }
    </style> -->
</head>
<body>

    <main id="admin">
        <div id="admin-menu">
            <ul>
                <li><a href="#edit-about">Text: About</a></li>
                <li><a href="#edit-gigs">Edit: Gigs</a></li>
            </ul>
        </div>
        <div class="edit-outer">
            <div class="edit-inner">
                <h2>Edit About Text</h2>
                <textarea id="adminAboutText"></textarea>
                <div class="button-block">
                    <button onclick="saveText()">Save</button>
                    <p id="status"></p>
                </div>
            </div>
            <div class="edit-inner">
                <div class="preview-heading">
                    <h3>Preview</h3>
                    <h5> — Reload to see changes</h5>
                </div>
                <p class="preview" id="preview-about">This display is updated automatically.</p>
            </div>
        </div>

        <h2 id="edit-gigs">Edit Gigs</h2>
        <a href="https://docs.google.com/spreadsheets/d/1DUgBEpNiNear4spHeeysMkhfGlInb-StFHKaeO2laos/edit?usp=sharing">Manage Tour Dates</a>
    </main>
    <script>
        async function loadText() {
            try {
                const response = await fetch('/api/about-text');
                const data = await response.json();
                const plainText = _.chain(data.text)
                    .replace(/<\/p><p>/g, '\n\n') // Convert paragraph separation
                    .replace(/<br>/g, '\n')       // Convert line breaks
                    .replace(/^<p>|<\/p>$/g, '') // Remove outer <p> tags
                    .value();
                document.getElementById('adminAboutText').value = plainText;
                document.getElementById('preview-about').innerHTML = data.text; // Preview with formatting
            } catch (error) {
                console.error("Failed to load text:", error);
                document.getElementById('status').textContent = "⚠ Could not load text.";
            }
        }
    
        async function saveText() {
            const plainText = document.getElementById('adminAboutText').value;
            const formattedText = _.chain(plainText)
                .split(/\n{2,}/)
                .map(paragraph => `<p>${_.replace(paragraph, /\n/g, '<br>')}</p>`)
                .join('')
                .value();
    
            try {
                const response = await fetch('/api/update-text', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: formattedText })
                });
                const result = await response.json();
                document.getElementById('status').textContent = result.message || "⚠ Error saving text.";
            } catch (error) {
                console.error("Failed to save text:", error);
                document.getElementById('status').textContent = "⚠ Could not save text.";
            }
        }
    
        // Load existing text on page load
        loadText();
    </script>

</body>
</html>